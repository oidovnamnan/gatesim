rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Auth helpers
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // Hardcoded superadmins list matching the server-side list
      return isAuthenticated() && (
        request.auth.token.email == 'admin@originals.mn' || 
        request.auth.token.email == 'oidovnamnan7@gmail.com'
      );
    }

    // PRODUCTS - Public reading, admin writing
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // SYSTEM - Public reading, admin writing
    match /system/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // USERS - User can read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // ORDERS - User can read their own orders. Admin can do anything.
    match /orders/{orderId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // TRIPS - User ownership
    match /trips/{tripId} {
      allow read, write, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
    }

    // SESSIONS - Presence analytics (Everyone can create/write their own, Admin can read)
    match /sessions/{sessionId} {
      allow read: if isAdmin();
      allow write, create, delete: if true; // Analytics usually doesn't require hard auth
    }

    // PUSH_SUBSCRIPTIONS - User ownership
    match /push_subscriptions/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // ADMIN_PUSH_SUBSCRIPTIONS - Admin only
    match /admin_push_subscriptions/{userId} {
      allow read, write: if isAdmin();
    }

    // AI_HUB - Admin only
    match /ai_hub/{docId} {
      allow read, write: if isAdmin();
    }

    // AI_CONFIG - Public read, Admin write
    match /ai_config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ADMIN_NOTIFICATIONS - Admin only
    match /admin_notifications/{notifId} {
      allow read, write: if isAdmin();
    }

    // Global default: Deny all
    match /{document=**} {
      allow read: if isAdmin();
      allow write: if false;
    }
  }
}
